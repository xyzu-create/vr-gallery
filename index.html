<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œå“ç·šä¸Šè—å»Š VR Gallery</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        
        #info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        #info-panel h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #D4AF37;
        }
        
        #info-panel p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        #controls button {
            background: #8B7355;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #controls button:hover {
            background: #A0826D;
            transform: scale(1.05);
        }
        
        #comment-panel {
            position: fixed;
            top: 50%;
            right: -400px;
            transform: translateY(-50%);
            width: 350px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 25px;
            border-radius: 10px 0 0 10px;
            z-index: 1000;
            transition: right 0.3s;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        #comment-panel.open {
            right: 0;
        }
        
        #comment-panel h3 {
            margin: 0 0 15px 0;
            color: #D4AF37;
            font-size: 18px;
        }
        
        #comment-panel input,
        #comment-panel textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #8B7355;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        #comment-panel textarea {
            height: 80px;
            resize: vertical;
        }
        
        #comment-panel button {
            background: #8B7355;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        #comment-panel button:hover {
            background: #A0826D;
        }
        
        .comment {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #D4AF37;
        }
        
        .comment-author {
            font-weight: bold;
            color: #D4AF37;
            margin-bottom: 5px;
        }
        
        .comment-text {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .comment-time {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        #toggle-comment {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: #8B7355;
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #toggle-comment:hover {
            background: #A0826D;
            padding-right: 15px;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 2000;
            text-align: center;
            font-size: 18px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #D4AF37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            #info-panel {
                max-width: 280px;
                padding: 15px;
            }
            
            #comment-panel {
                width: 90%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        æ­£åœ¨è¼‰å…¥è—å»Š...
    </div>
    
    <div id="info-panel">
        <h2>ğŸ¨ å­¸ç”Ÿä½œå“ç·šä¸Šè—å»Š</h2>
        <p><strong>ç›®å‰ä½œå“ï¼š</strong><span id="current-artwork">è¼‰å…¥ä¸­...</span></p>
        <p><strong>ç¸½ä½œå“æ•¸ï¼š</strong>126 ä»¶</p>
        <p><strong>æ“ä½œèªªæ˜ï¼š</strong></p>
        <p>â€¢ æ»‘é¼ æ‹–æ›³ï¼šç’°è¦–å››å‘¨</p>
        <p>â€¢ WASD / æ–¹å‘éµï¼šç§»å‹•</p>
        <p>â€¢ é»æ“Šä½œå“ï¼šæŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
        <p>â€¢ VRæ¨¡å¼ï¼šä½¿ç”¨VRé ­æˆ´è£ç½®é«”é©—</p>
    </div>
    
    <div id="controls">
        <button id="prev-btn">â¬… ä¸Šä¸€ä»¶</button>
        <button id="next-btn">ä¸‹ä¸€ä»¶ â¡</button>
        <button id="vr-btn">ğŸ¥½ é€²å…¥VRæ¨¡å¼</button>
    </div>
    
    <button id="toggle-comment">ç•™è¨€æ¿</button>
    
    <div id="comment-panel">
        <h3>ğŸ’¬ ç•™è¨€å›é¥‹</h3>
        <p style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
            é‡å°ä½œå“ï¼š<span id="comment-artwork-title">-</span>
        </p>
        
        <input type="text" id="comment-name" placeholder="æ‚¨çš„åå­—" maxlength="50">
        <textarea id="comment-text" placeholder="è«‹ç•™ä¸‹æ‚¨çš„å›é¥‹..." maxlength="500"></textarea>
        <button id="submit-comment">é€å‡ºç•™è¨€</button>
        
        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
            <h4 style="color: #4CAF50; margin-bottom: 15px;">æ‰€æœ‰ç•™è¨€</h4>
            <div id="comments-list"></div>
        </div>
    </div>

    <a-scene loading-screen="enabled: false">
        <!-- 360åº¦ç¾è¡“é¤¨èƒŒæ™¯ -->
        <a-sky src="gallery_360_background.jpg" rotation="0 0 0"></a-sky>
        
        <!-- ç’°å¢ƒå…‰å’Œç‡ˆå…‰ï¼ˆèª¿æ•´ç‚ºæ›´è‡ªç„¶çš„ç¾è¡“é¤¨å…‰ç·šï¼‰-->
        <a-entity light="type: ambient; intensity: 0.9; color: #FFF8E7"></a-entity>
        <a-entity light="type: directional; intensity: 0.6; color: #FFFFFF" position="2 4 1"></a-entity>
        <a-entity light="type: point; intensity: 0.4; color: #FFF4E0" position="0 3 0"></a-entity>
        
        <!-- åœ°æ¿ï¼ˆæœ¨è³ªåœ°æ¿æ•ˆæœï¼‰-->
        <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" 
                 color="#C8A882" shadow="receive: true" 
                 material="roughness: 0.8; metalness: 0.1"></a-plane>
        
        <!-- ç•«å»Šçµæ§‹ -->
        <a-entity id="gallery-container"></a-entity>
        
        <!-- ç›¸æ©Ÿï¼ˆç©å®¶è¦–è§’ï¼‰ -->
        <a-entity id="camera-rig" position="0 1.6 12">
            <a-camera id="camera" look-controls wasd-controls>
                <a-cursor color="#D4AF37" opacity="0.9" 
                         raycaster="objects: .artwork-image"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // è¼‰å…¥åœ–ç‰‡ä¿¡æ¯
        let artworks = [];
        let currentIndex = 0;
        let comments = JSON.parse(localStorage.getItem('galleryComments') || '[]');
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                const response = await fetch('gallery_images/image_info.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                artworks = data;
                
                if (!artworks || artworks.length === 0) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°ä½œå“è³‡æ–™');
                }
                
                createGallery();
                updateInfo();
                loadComments();
                
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('loading').innerHTML = 
                    `<p style="color: #ff6b6b;">è¼‰å…¥å¤±æ•—</p>
                    <p style="font-size: 14px; margin-top: 10px;">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    <p style="font-size: 12px; margin-top: 10px;">è«‹ç¢ºèªï¼š<br>
                    1. ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨é–‹å•Ÿï¼ˆä¸è¦ç›´æ¥é›™æ“ŠHTMLï¼‰<br>
                    2. gallery_images è³‡æ–™å¤¾å­˜åœ¨<br>
                    3. image_info.json æª”æ¡ˆå­˜åœ¨</p>`;
            }
        }
        
        // å‰µå»ºç•«å»Š
        function createGallery() {
            const container = document.getElementById('gallery-container');
            
            // ä½¿ç”¨å¤šç¨®ä½ˆå±€æ–¹å¼ï¼Œé¿å…éæ–¼æ•´é½Š
            const layouts = [
                createCircularGallery,
                createWallGallery,
                createCornerGallery
            ];
            
            let artworkIndex = 0;
            
            // ä¸»åœ“å½¢ç•«å»Šï¼ˆä¸­å¤®å±•å€ï¼‰
            artworkIndex = createCircularGallery(container, artworkIndex, 18, 8, 0);
            
            // å·¦å´ç‰†é¢å±•å€
            artworkIndex = createWallGallery(container, artworkIndex, -10, -5, 20, 3, 4);
            
            // å³å´ç‰†é¢å±•å€
            artworkIndex = createWallGallery(container, artworkIndex, 10, -5, 20, 3, 4);
            
            // å¾Œæ–¹å±•å€ï¼ˆè¼ƒé ï¼‰
            artworkIndex = createWallGallery(container, artworkIndex, 0, -20, 30, 4, 5);
            
            // è§’è½å±•å€
            if (artworkIndex < artworks.length) {
                createCornerGallery(container, artworkIndex);
            }
        }
        
        // åœ“å½¢ç•«å»Šä½ˆå±€ï¼ˆä¸»å±•å€ï¼‰
        function createCircularGallery(container, startIndex, count, radius, yOffset) {
            const endIndex = Math.min(startIndex + count, artworks.length);
            const actualCount = endIndex - startIndex;
            
            for (let i = 0; i < actualCount; i++) {
                const index = startIndex + i;
                const angle = (i / actualCount) * Math.PI * 2;
                
                // æ·»åŠ éš¨æ©Ÿåç§»ï¼Œä½¿æ’åˆ—ä¸é‚£éº¼è¦å‰‡
                const radiusVariation = radius + (Math.random() - 0.5) * 1.5;
                const angleVariation = angle + (Math.random() - 0.5) * 0.15;
                
                const x = Math.sin(angleVariation) * radiusVariation;
                const z = Math.cos(angleVariation) * radiusVariation;
                const y = 1.6 + yOffset + (Math.random() - 0.5) * 0.3; // é«˜åº¦ä¹Ÿæœ‰è®ŠåŒ–
                const rotation = -(angleVariation * 180 / Math.PI) + (Math.random() - 0.5) * 5;
                
                createArtworkFrame(container, index, x, y, z, rotation, 2.2, 1.8);
            }
            
            return endIndex;
        }
        
        // ç‰†é¢ç•«å»Šä½ˆå±€ï¼ˆå´é¢å±•å€ï¼‰
        function createWallGallery(container, startIndex, centerX, startZ, wallLength, rows, cols) {
            let index = startIndex;
            const spacing = wallLength / (cols + 1);
            
            for (let row = 0; row < rows && index < artworks.length; row++) {
                for (let col = 0; col < cols && index < artworks.length; col++) {
                    const x = centerX + (Math.random() - 0.5) * 0.5;
                    const z = startZ - col * spacing + (Math.random() - 0.5) * 0.8;
                    const y = 1.8 - row * 0.5 + (Math.random() - 0.5) * 0.2;
                    
                    // é¢å‘ä¸­å¿ƒæˆ–ç•¥æœ‰è§’åº¦
                    let rotation = centerX > 0 ? -90 : 90;
                    rotation += (Math.random() - 0.5) * 10;
                    
                    const width = 2.0 + Math.random() * 0.6;
                    const height = 1.6 + Math.random() * 0.5;
                    
                    createArtworkFrame(container, index, x, y, z, rotation, width, height);
                    index++;
                }
            }
            
            return index;
        }
        
        // è§’è½ç•«å»Šä½ˆå±€ï¼ˆå¡«å……å‰©é¤˜ç©ºé–“ï¼‰
        function createCornerGallery(container, startIndex) {
            const corners = [
                { x: -12, z: -12, rotation: 45 },
                { x: 12, z: -12, rotation: -45 },
                { x: -12, z: 12, rotation: 135 },
                { x: 12, z: 12, rotation: -135 }
            ];
            
            let index = startIndex;
            for (const corner of corners) {
                if (index >= artworks.length) break;
                
                const x = corner.x + (Math.random() - 0.5) * 2;
                const z = corner.z + (Math.random() - 0.5) * 2;
                const y = 1.6 + (Math.random() - 0.5) * 0.4;
                const rotation = corner.rotation + (Math.random() - 0.5) * 20;
                
                createArtworkFrame(container, index, x, y, z, rotation, 2.0, 1.6);
                index++;
            }
        }
        
        // å‰µå»ºä½œå“æ¡†æ¶å’Œåœ–ç‰‡
        function createArtworkFrame(container, index, x, y, z, rotation, width, height) {
            const artwork = artworks[index];
            
            // å‰µå»ºç•«æ¡†ï¼ˆç±³ç™½è‰²å„ªé›…æ¡†æ¶ï¼‰
            const frame = document.createElement('a-box');
            frame.setAttribute('position', `${x} ${y} ${z}`);
            frame.setAttribute('rotation', `0 ${rotation} 0`);
            frame.setAttribute('width', width + 0.2);
            frame.setAttribute('height', height + 0.2);
            frame.setAttribute('depth', '0.08');
            frame.setAttribute('color', '#F5F5DC');
            frame.setAttribute('shadow', 'cast: true');
            frame.setAttribute('material', 'roughness: 0.3; metalness: 0.2');
            
            // å‰µå»ºå…§æ¡†ï¼ˆæ·±è‰²ï¼‰
            const innerFrame = document.createElement('a-box');
            const offsetX = Math.sin(rotation * Math.PI / 180) * 0.04;
            const offsetZ = Math.cos(rotation * Math.PI / 180) * 0.04;
            innerFrame.setAttribute('position', `${x + offsetX} ${y} ${z - offsetZ}`);
            innerFrame.setAttribute('rotation', `0 ${rotation} 0`);
            innerFrame.setAttribute('width', width + 0.1);
            innerFrame.setAttribute('height', height + 0.1);
            innerFrame.setAttribute('depth', '0.06');
            innerFrame.setAttribute('color', '#8B7355');
            
            // å‰µå»ºåœ–ç‰‡
            const image = document.createElement('a-image');
            const imgOffsetX = Math.sin(rotation * Math.PI / 180) * 0.05;
            const imgOffsetZ = Math.cos(rotation * Math.PI / 180) * 0.05;
            image.setAttribute('src', `gallery_images/${artwork.filename}`);
            image.setAttribute('position', `${x + imgOffsetX} ${y} ${z - imgOffsetZ}`);
            image.setAttribute('rotation', `0 ${rotation} 0`);
            image.setAttribute('width', width);
            image.setAttribute('height', height);
            image.setAttribute('class', 'artwork-image');
            image.setAttribute('data-index', index);
            
            // æ·»åŠ èšå…‰ç‡ˆæ•ˆæœ
            const spotlight = document.createElement('a-entity');
            spotlight.setAttribute('light', 'type: spot; intensity: 0.6; angle: 45; penumbra: 0.5; color: #FFF8E7');
            spotlight.setAttribute('position', `${x} ${y + 1.5} ${z}`);
            spotlight.setAttribute('rotation', '-45 0 0');
            
            // é»æ“Šäº‹ä»¶
            image.addEventListener('click', () => {
                currentIndex = index;
                updateInfo();
                focusOnArtwork(x, z, rotation);
            });
            
            // å‰µå»ºæ¨™é¡Œç‰Œï¼ˆæ›´å°æ›´ç²¾ç·»ï¼‰
            const titleBg = document.createElement('a-box');
            const titleOffsetX = Math.sin(rotation * Math.PI / 180) * 0.06;
            const titleOffsetZ = Math.cos(rotation * Math.PI / 180) * 0.06;
            titleBg.setAttribute('position', `${x + titleOffsetX} ${y - height/2 - 0.3} ${z - titleOffsetZ}`);
            titleBg.setAttribute('rotation', `0 ${rotation} 0`);
            titleBg.setAttribute('width', width * 0.8);
            titleBg.setAttribute('height', '0.15');
            titleBg.setAttribute('depth', '0.02');
            titleBg.setAttribute('color', '#F5F5DC');
            
            const titleEntity = document.createElement('a-entity');
            titleEntity.setAttribute('position', `${x + titleOffsetX} ${y - height/2 - 0.3} ${z - titleOffsetZ + 0.02}`);
            titleEntity.setAttribute('rotation', `0 ${rotation} 0`);
            titleEntity.setAttribute('text', {
                value: artwork.source.substring(0, 20) + (artwork.source.length > 20 ? '...' : ''),
                align: 'center',
                width: width * 0.7,
                color: '#2C2416',
                font: 'roboto'
            });
            
            container.appendChild(frame);
            container.appendChild(innerFrame);
            container.appendChild(image);
            container.appendChild(spotlight);
            container.appendChild(titleBg);
            container.appendChild(titleEntity);
        }
        
        // èšç„¦åˆ°ä½œå“
        function focusOnArtwork(x, z, rotation) {
            const cameraRig = document.getElementById('camera-rig');
            const distance = 3;
            const newX = x - Math.sin(rotation * Math.PI / 180) * distance;
            const newZ = z - Math.cos(rotation * Math.PI / 180) * distance;
            
            cameraRig.setAttribute('animation', {
                property: 'position',
                to: `${newX} 1.6 ${newZ}`,
                dur: 1000,
                easing: 'easeInOutQuad'
            });
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfo() {
            if (!artworks || artworks.length === 0 || !artworks[currentIndex]) {
                console.error('æ²’æœ‰å¯ç”¨çš„ä½œå“è³‡æ–™');
                return;
            }
            const artwork = artworks[currentIndex];
            document.getElementById('current-artwork').textContent = 
                `${artwork.title || artwork.source} (${currentIndex + 1}/${artworks.length})`;
            document.getElementById('comment-artwork-title').textContent = 
                artwork.title || artwork.source;
        }
        
        // å°èˆªæ§åˆ¶
        document.getElementById('prev-btn').addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + artworks.length) % artworks.length;
            updateInfo();
            navigateToArtwork(currentIndex);
        });
        
        document.getElementById('next-btn').addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % artworks.length;
            updateInfo();
            navigateToArtwork(currentIndex);
        });
        
        function navigateToArtwork(index) {
            const images = document.querySelectorAll('.artwork-image');
            if (images[index]) {
                images[index].click();
            }
        }
        
        // VRæŒ‰éˆ•
        document.getElementById('vr-btn').addEventListener('click', () => {
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.enterVR();
            }
        });
        
        // ç•™è¨€æ¿æ§åˆ¶
        const commentPanel = document.getElementById('comment-panel');
        const toggleBtn = document.getElementById('toggle-comment');
        
        toggleBtn.addEventListener('click', () => {
            commentPanel.classList.toggle('open');
            toggleBtn.textContent = commentPanel.classList.contains('open') ? 'é—œé–‰' : 'ç•™è¨€æ¿';
        });
        
        // æäº¤ç•™è¨€
        document.getElementById('submit-comment').addEventListener('click', () => {
            const name = document.getElementById('comment-name').value.trim();
            const text = document.getElementById('comment-text').value.trim();
            
            if (!name || !text) {
                alert('è«‹å¡«å¯«å§“åå’Œç•™è¨€å…§å®¹');
                return;
            }
            
            if (!artworks || !artworks[currentIndex]) {
                alert('ç„¡æ³•å–å¾—ä½œå“è³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }
            
            const artwork = artworks[currentIndex];
            const comment = {
                artworkIndex: currentIndex,
                artworkTitle: artwork.title || artwork.source,
                author: name,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            comments.push(comment);
            localStorage.setItem('galleryComments', JSON.stringify(comments));
            
            document.getElementById('comment-name').value = '';
            document.getElementById('comment-text').value = '';
            
            loadComments();
            alert('ç•™è¨€å·²é€å‡ºï¼');
        });
        
        // è¼‰å…¥ç•™è¨€
        function loadComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            const filteredComments = comments
                .filter(c => c.artworkIndex === currentIndex)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredComments.length === 0) {
                commentsList.innerHTML = '<p style="color: #888; font-size: 13px;">é‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>';
                return;
            }
            
            filteredComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                
                const date = new Date(comment.timestamp);
                const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                commentDiv.innerHTML = `
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-time">${timeStr}</div>
                `;
                
                commentsList.appendChild(commentDiv);
            });
        }
        
        // ç›£è½ç•¶å‰ä½œå“è®ŠåŒ–ä»¥æ›´æ–°ç•™è¨€
        setInterval(() => {
            if (!artworks || !artworks[currentIndex]) return;
            const currentTitle = document.getElementById('comment-artwork-title').textContent;
            const artworkTitle = artworks[currentIndex].title || artworks[currentIndex].source;
            if (currentTitle !== artworkTitle) {
                loadComments();
            }
        }, 500);
        
        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
