<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿä½œå“ç·šä¸Šè—å»Š VR Gallery</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }
        
        #info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        #info-panel h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #4CAF50;
        }
        
        #info-panel p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        #controls button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #controls button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        #comment-panel {
            position: fixed;
            top: 50%;
            right: -400px;
            transform: translateY(-50%);
            width: 350px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 25px;
            border-radius: 10px 0 0 10px;
            z-index: 1000;
            transition: right 0.3s;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        #comment-panel.open {
            right: 0;
        }
        
        #comment-panel h3 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            font-size: 18px;
        }
        
        #comment-panel input,
        #comment-panel textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        #comment-panel textarea {
            height: 80px;
            resize: vertical;
        }
        
        #comment-panel button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        #comment-panel button:hover {
            background: #45a049;
        }
        
        .comment {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        
        .comment-author {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .comment-text {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .comment-time {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        #toggle-comment {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #toggle-comment:hover {
            background: #45a049;
            padding-right: 15px;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 2000;
            text-align: center;
            font-size: 18px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            #info-panel {
                max-width: 280px;
                padding: 15px;
            }
            
            #comment-panel {
                width: 90%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        æ­£åœ¨è¼‰å…¥è—å»Š...
    </div>
    
    <div id="info-panel">
        <h2>ğŸ¨ å­¸ç”Ÿä½œå“ç·šä¸Šè—å»Š</h2>
        <p><strong>ç›®å‰ä½œå“ï¼š</strong><span id="current-artwork">è¼‰å…¥ä¸­...</span></p>
        <p><strong>ç¸½ä½œå“æ•¸ï¼š</strong>126 ä»¶</p>
        <p><strong>æ“ä½œèªªæ˜ï¼š</strong></p>
        <p>â€¢ æ»‘é¼ æ‹–æ›³ï¼šç’°è¦–å››å‘¨</p>
        <p>â€¢ WASD / æ–¹å‘éµï¼šç§»å‹•</p>
        <p>â€¢ é»æ“Šä½œå“ï¼šæŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
        <p>â€¢ VRæ¨¡å¼ï¼šä½¿ç”¨VRé ­æˆ´è£ç½®é«”é©—</p>
    </div>
    
    <div id="controls">
        <button id="prev-btn">â¬… ä¸Šä¸€ä»¶</button>
        <button id="next-btn">ä¸‹ä¸€ä»¶ â¡</button>
        <button id="vr-btn">ğŸ¥½ é€²å…¥VRæ¨¡å¼</button>
    </div>
    
    <button id="toggle-comment">ç•™è¨€æ¿</button>
    
    <div id="comment-panel">
        <h3>ğŸ’¬ ç•™è¨€å›é¥‹</h3>
        <p style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
            é‡å°ä½œå“ï¼š<span id="comment-artwork-title">-</span>
        </p>
        
        <input type="text" id="comment-name" placeholder="æ‚¨çš„åå­—" maxlength="50">
        <textarea id="comment-text" placeholder="è«‹ç•™ä¸‹æ‚¨çš„å›é¥‹..." maxlength="500"></textarea>
        <button id="submit-comment">é€å‡ºç•™è¨€</button>
        
        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #333;">
            <h4 style="color: #4CAF50; margin-bottom: 15px;">æ‰€æœ‰ç•™è¨€</h4>
            <div id="comments-list"></div>
        </div>
    </div>

    <a-scene loading-screen="enabled: false">
        <!-- å¤©ç©ºèƒŒæ™¯ -->
        <a-sky color="#1a1a2e"></a-sky>
        
        <!-- ç’°å¢ƒå…‰å’Œç‡ˆå…‰ -->
        <a-entity light="type: ambient; intensity: 0.8"></a-entity>
        <a-entity light="type: directional; intensity: 0.5" position="1 2 1"></a-entity>
        
        <!-- åœ°æ¿ -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="50" height="50" 
                 color="#0f3460" shadow="receive: true"></a-plane>
        
        <!-- ç•«å»Šçµæ§‹ -->
        <a-entity id="gallery-container"></a-entity>
        
        <!-- ç›¸æ©Ÿï¼ˆç©å®¶è¦–è§’ï¼‰ -->
        <a-entity id="camera-rig" position="0 1.6 5">
            <a-camera id="camera" look-controls wasd-controls>
                <a-cursor color="#4CAF50" opacity="0.8"></a-cursor>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // è¼‰å…¥åœ–ç‰‡ä¿¡æ¯
        let artworks = [];
        let currentIndex = 0;
        let comments = JSON.parse(localStorage.getItem('galleryComments') || '[]');
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                const response = await fetch('gallery_images/image_info.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                artworks = data;
                
                if (!artworks || artworks.length === 0) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°ä½œå“è³‡æ–™');
                }
                
                createGallery();
                updateInfo();
                loadComments();
                
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('loading').innerHTML = 
                    `<p style="color: #ff6b6b;">è¼‰å…¥å¤±æ•—</p>
                    <p style="font-size: 14px; margin-top: 10px;">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    <p style="font-size: 12px; margin-top: 10px;">è«‹ç¢ºèªï¼š<br>
                    1. ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨é–‹å•Ÿï¼ˆä¸è¦ç›´æ¥é›™æ“ŠHTMLï¼‰<br>
                    2. gallery_images è³‡æ–™å¤¾å­˜åœ¨<br>
                    3. image_info.json æª”æ¡ˆå­˜åœ¨</p>`;
            }
        }
        
        // å‰µå»ºç•«å»Š
        function createGallery() {
            const container = document.getElementById('gallery-container');
            const radius = 8; // åœ“å½¢ç•«å»Šçš„åŠå¾‘
            const totalWalls = Math.min(artworks.length, 24); // æœ€å¤šé¡¯ç¤º24ä»¶ä½œå“åœ¨åœ“å½¢ç•«å»Š
            
            for (let i = 0; i < totalWalls; i++) {
                const angle = (i / totalWalls) * Math.PI * 2;
                const x = Math.sin(angle) * radius;
                const z = Math.cos(angle) * radius;
                const rotation = -(angle * 180 / Math.PI);
                
                // å‰µå»ºç•«æ¡†
                const frame = document.createElement('a-box');
                frame.setAttribute('position', `${x} 1.6 ${z}`);
                frame.setAttribute('rotation', `0 ${rotation} 0`);
                frame.setAttribute('width', '2.5');
                frame.setAttribute('height', '2');
                frame.setAttribute('depth', '0.05');
                frame.setAttribute('color', '#16213e');
                frame.setAttribute('shadow', 'cast: true');
                
                // å‰µå»ºåœ–ç‰‡
                const artwork = artworks[i];
                const image = document.createElement('a-image');
                image.setAttribute('src', `gallery_images/${artwork.filename}`);
                image.setAttribute('position', `${x} 1.6 ${z - 0.03}`);
                image.setAttribute('rotation', `0 ${rotation} 0`);
                image.setAttribute('width', '2.3');
                image.setAttribute('height', '1.8');
                image.setAttribute('class', 'artwork-image');
                image.setAttribute('data-index', i);
                
                // é»æ“Šäº‹ä»¶
                image.addEventListener('click', () => {
                    currentIndex = i;
                    updateInfo();
                    focusOnArtwork(x, z, rotation);
                });
                
                // å‰µå»ºæ¨™é¡Œç‰Œ
                const titleEntity = document.createElement('a-entity');
                titleEntity.setAttribute('position', `${x} 0.8 ${z - 0.1}`);
                titleEntity.setAttribute('rotation', `0 ${rotation} 0`);
                titleEntity.setAttribute('text', {
                    value: artwork.source.substring(0, 15) + '...',
                    align: 'center',
                    width: 2,
                    color: '#4CAF50'
                });
                
                container.appendChild(frame);
                container.appendChild(image);
                container.appendChild(titleEntity);
            }
            
            // å¦‚æœä½œå“è¶…é24ä»¶ï¼Œå‰µå»ºé¡å¤–çš„å±•ç¤ºå€åŸŸ
            if (artworks.length > 24) {
                createAdditionalGalleries();
            }
        }
        
        // å‰µå»ºé¡å¤–çš„ç•«å»Šå€åŸŸ
        function createAdditionalGalleries() {
            const container = document.getElementById('gallery-container');
            const remaining = artworks.length - 24;
            const rows = Math.ceil(remaining / 6);
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < 6; col++) {
                    const index = 24 + row * 6 + col;
                    if (index >= artworks.length) break;
                    
                    const x = (col - 2.5) * 3;
                    const z = -15 - row * 4;
                    
                    const frame = document.createElement('a-box');
                    frame.setAttribute('position', `${x} 1.6 ${z}`);
                    frame.setAttribute('width', '2.5');
                    frame.setAttribute('height', '2');
                    frame.setAttribute('depth', '0.05');
                    frame.setAttribute('color', '#16213e');
                    
                    const artwork = artworks[index];
                    const image = document.createElement('a-image');
                    image.setAttribute('src', `gallery_images/${artwork.filename}`);
                    image.setAttribute('position', `${x} 1.6 ${z + 0.03}`);
                    image.setAttribute('width', '2.3');
                    image.setAttribute('height', '1.8');
                    image.setAttribute('data-index', index);
                    
                    image.addEventListener('click', () => {
                        currentIndex = index;
                        updateInfo();
                    });
                    
                    container.appendChild(frame);
                    container.appendChild(image);
                }
            }
        }
        
        // èšç„¦åˆ°ä½œå“
        function focusOnArtwork(x, z, rotation) {
            const cameraRig = document.getElementById('camera-rig');
            const distance = 3;
            const newX = x - Math.sin(rotation * Math.PI / 180) * distance;
            const newZ = z - Math.cos(rotation * Math.PI / 180) * distance;
            
            cameraRig.setAttribute('animation', {
                property: 'position',
                to: `${newX} 1.6 ${newZ}`,
                dur: 1000,
                easing: 'easeInOutQuad'
            });
        }
        
        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfo() {
            if (!artworks || artworks.length === 0 || !artworks[currentIndex]) {
                console.error('æ²’æœ‰å¯ç”¨çš„ä½œå“è³‡æ–™');
                return;
            }
            const artwork = artworks[currentIndex];
            document.getElementById('current-artwork').textContent = 
                `${artwork.title || artwork.source} (${currentIndex + 1}/${artworks.length})`;
            document.getElementById('comment-artwork-title').textContent = 
                artwork.title || artwork.source;
        }
        
        // å°èˆªæ§åˆ¶
        document.getElementById('prev-btn').addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + artworks.length) % artworks.length;
            updateInfo();
            navigateToArtwork(currentIndex);
        });
        
        document.getElementById('next-btn').addEventListener('click', () => {
            currentIndex = (currentIndex + 1) % artworks.length;
            updateInfo();
            navigateToArtwork(currentIndex);
        });
        
        function navigateToArtwork(index) {
            const images = document.querySelectorAll('.artwork-image');
            if (images[index]) {
                images[index].click();
            }
        }
        
        // VRæŒ‰éˆ•
        document.getElementById('vr-btn').addEventListener('click', () => {
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.enterVR();
            }
        });
        
        // ç•™è¨€æ¿æ§åˆ¶
        const commentPanel = document.getElementById('comment-panel');
        const toggleBtn = document.getElementById('toggle-comment');
        
        toggleBtn.addEventListener('click', () => {
            commentPanel.classList.toggle('open');
            toggleBtn.textContent = commentPanel.classList.contains('open') ? 'é—œé–‰' : 'ç•™è¨€æ¿';
        });
        
        // æäº¤ç•™è¨€
        document.getElementById('submit-comment').addEventListener('click', () => {
            const name = document.getElementById('comment-name').value.trim();
            const text = document.getElementById('comment-text').value.trim();
            
            if (!name || !text) {
                alert('è«‹å¡«å¯«å§“åå’Œç•™è¨€å…§å®¹');
                return;
            }
            
            if (!artworks || !artworks[currentIndex]) {
                alert('ç„¡æ³•å–å¾—ä½œå“è³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }
            
            const artwork = artworks[currentIndex];
            const comment = {
                artworkIndex: currentIndex,
                artworkTitle: artwork.title || artwork.source,
                author: name,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            comments.push(comment);
            localStorage.setItem('galleryComments', JSON.stringify(comments));
            
            document.getElementById('comment-name').value = '';
            document.getElementById('comment-text').value = '';
            
            loadComments();
            alert('ç•™è¨€å·²é€å‡ºï¼');
        });
        
        // è¼‰å…¥ç•™è¨€
        function loadComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            const filteredComments = comments
                .filter(c => c.artworkIndex === currentIndex)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredComments.length === 0) {
                commentsList.innerHTML = '<p style="color: #888; font-size: 13px;">é‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>';
                return;
            }
            
            filteredComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                
                const date = new Date(comment.timestamp);
                const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                commentDiv.innerHTML = `
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-text">${comment.text}</div>
                    <div class="comment-time">${timeStr}</div>
                `;
                
                commentsList.appendChild(commentDiv);
            });
        }
        
        // ç›£è½ç•¶å‰ä½œå“è®ŠåŒ–ä»¥æ›´æ–°ç•™è¨€
        setInterval(() => {
            if (!artworks || !artworks[currentIndex]) return;
            const currentTitle = document.getElementById('comment-artwork-title').textContent;
            const artworkTitle = artworks[currentIndex].title || artworks[currentIndex].source;
            if (currentTitle !== artworkTitle) {
                loadComments();
            }
        }, 500);
        
        // å•Ÿå‹•
        window.addEventListener('load', init);
    </script>
</body>
</html>
